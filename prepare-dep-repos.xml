<?xml version="1.0" encoding="UTF-8"?>
<project name="create-repositories" default="default" basedir="..">
    <target name="default" depends="init,downloadEclipse,downloadDeltaPack,downloadTestFramework,downloadDTFJ">
    </target>

    	<target name="init" depends="initProperties,initProxy,initMatTargetDef"/>

	<target name="initProperties">
		<mkdir dir="p2tool"/>
		<makeurl property="target.baseUrl">
			<path location="p2tool/."/>
		</makeurl>
		<property environment="env"/>
	</target>

	<target name="initProxy" if="env.proxyHost">
		<echo message="Setting proxy: ${env.proxyHost}:${env.proxyPort}"/>
		<setproxy proxyhost="${env.proxyHost}" proxyport="${env.proxyPort}"/>
	</target>

	<target name="initMatTargetDef">
		<makeurl property="workspace.baseUrl">
			<path location="."/>
		</makeurl>
		<replace file="${ant.file}/../org.eclipse.mat.targetdef/mat-site.target" token="%workspaceUrl%" value="${workspace.baseUrl}"/>
	</target>

	<target name="downloadEclipse">
		<get 
			src="http://download.eclipse.org/eclipse/downloads/drops/R-3.6-201006080911/eclipse-SDK-3.6-linux-gtk-ppc.tar.gz"
			dest="p2tool/eclipse-SDK-3.6-linux-gtk-ppc.tar.gz"
			verbose="true"/>

	    	<delete dir="p2tool/eclipse"/>
		<untar src="p2tool/eclipse-SDK-3.6-linux-gtk-ppc.tar.gz" dest="p2tool/eclipse" compression="gzip"/>
	</target>
	
	<target name="downloadDeltaPack" description="downloadDeltaPack" depends="downloadEclipse">
		<get	
			src="http://download.eclipse.org/eclipse/downloads/drops/R-3.6-201006080911/eclipse-3.6-delta-pack.zip"
			dest="p2tool/eclipse-3.6-delta-pack.zip"
			verbose="true"/>
		
		<unzip src="p2tool/eclipse-3.6-delta-pack.zip" dest="p2tool/eclipse-delta-pack"/>
	
		<java jar="p2tool/eclipse/eclipse/plugins/org.eclipse.equinox.launcher_1.1.0.v20100507.jar" fork="true" maxmemory="512m" failonerror="true">
	            <arg value="-consoleLog" />
	            <arg value="-application" />
	            <arg value="org.eclipse.equinox.p2.publisher.FeaturesAndBundlesPublisher"/>
	    		<arg value="-mr"/> 
	    		<arg value="${target.baseUrl}eclipse-delta-pack/repo"/> 
	    		<arg value="-ar"/> 
	    		<arg value="${target.baseUrl}eclipse-delta-pack/repo"/> 
	    		<arg value="-source"/> 
	    		<arg value="p2tool/eclipse-delta-pack/eclipse"/> 
	    		<arg value="-compress"/> 
	    		<arg value="-publishArtifacts"/> 
	        </java>
    	</target>
	
	<target name="downloadTestFramework" description="description" depends="downloadEclipse">
		<get 
    		src="http://download.eclipse.org/eclipse/downloads/drops/R-3.6-201006080911/eclipse-test-framework-3.6.zip" 
    		dest="p2tool/eclipse-test-framework.zip"/>
    	<delete dir="p2tool/eclipse-test-framework"/>
		<unzip src="p2tool/eclipse-test-framework.zip" dest="p2tool/eclipse-test-framework"/>

		<java jar="p2tool/eclipse/eclipse/plugins/org.eclipse.equinox.launcher_1.1.0.v20100507.jar" fork="true" maxmemory="512m" failonerror="true">
            <arg value="-consoleLog" />
            <arg value="-application" />
            <arg value="org.eclipse.equinox.p2.publisher.FeaturesAndBundlesPublisher"/>
    		<arg value="-mr"/> 
    		<arg value="${target.baseUrl}eclipse-test-framework/repo"/> 
    		<arg value="-ar"/> 
    		<arg value="${target.baseUrl}eclipse-test-framework/repo"/> 
    		<arg value="-source"/> 
    		<arg value="p2tool/eclipse-test-framework/eclipse"/> 
    		<arg value="-compress"/> 
    		<arg value="-publishArtifacts"/> 
        </java>
    </target>
	
    <target name="downloadDTFJ" description="description" depends="downloadEclipse">
    	<get 
    		src="ftp://ftp.software.ibm.com/software/java/support/tools/dtfj/dtfj-updatesite.zip" 
    		dest="p2tool/dtfj-updatesite.zip"/>
    	<delete dir="p2tool/dtfj-updatesite"/>
		<unzip src="p2tool/dtfj-updatesite.zip" dest="p2tool/dtfj-updatesite"/>
    	<java jar="p2tool/eclipse/eclipse/plugins/org.eclipse.equinox.launcher_1.1.0.v20100507.jar" fork="true" maxmemory="512m" failonerror="true">
            <arg value="-consoleLog" />
            <arg value="-application" />
            <arg value="org.eclipse.equinox.p2.publisher.UpdateSitePublisher"/>
    		<arg value="-mr"/> 
    		<arg value="${target.baseUrl}dtfj-updatesite/repo"/> 
    		<arg value="-ar"/> 
    		<arg value="${target.baseUrl}dtfj-updatesite/repo"/> 
    		<arg value="-source"/> 
    		<arg value="p2tool/dtfj-updatesite"/> 
    		<arg value="-compress"/> 
    		<arg value="-publishArtifacts"/> 
        </java>
    </target>

    <target name="cleanup" depends="cleanupTestFramework,cleanupDTFJ">
    </target>

    <target name="cleanupTestFramework" description="delete TestFramework repository">
	<delete dir="p2tool/eclipse-test-framework"/>
    <delete file="p2tool/eclipse-test-framework.zip"/>
    </target>
	
    <target name="cleanupDTFJ" description="delete DTFJ repository">
	<delete dir="p2tool/dtfj-updatesite"/>
   	<delete file="p2tool/dtfj-updatesite.zip"/>
    </target>
</project>
